{% extends "base.html" %} 
{% block title %}Аккаунт{% endblock %} 
{% block content %}
<h1 class="text-3xl font-bold mb-4">Аккаунт</h1>

{% if session.get('user_email') %}
<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
    ✓ Ви залогіновані як <strong>{{ session.get('user_email') }}</strong>
    <a href="{{ url_for('accounts.logout') }}" class="ml-4 text-green-600 hover:text-green-800 font-bold">Вийти</a>
</div>
{% endif %}

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
        <p class="text-lg">
            Авторизація на сайті дозволить вам не вписувати email для кожної купівлі. Email буде автоматично заповнено в кошику.
        </p>
    </div>
    
    <!-- Вкладки для вибору режиму -->
    <div>
        <div class="flex gap-2 mb-4">
            <button id="registerTab" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 font-bold">Реєстрація</button>
            <button id="loginTab" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 font-bold">Логін</button>
        </div>
        
        <!-- Форма реєстрації -->
        <form id="registerForm" action="{{ url_for('accounts.accounts') }}" method="POST" class="max-w-lg ml-0 mt-4">
            <input type="hidden" name="action" value="register">
            <div class="mb-4">
                <label for="register_email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                <input type="email" id="register_email" name="email" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="register_password" class="block text-gray-700 text-sm font-bold mb-2">Пароль:</label>
                <input type="password" id="register_password" name="password" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="flex items-center justify-between">
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Реєструватися
                </button>
            </div>
        </form>
        
        <!-- Форма логіну -->
        <form id="loginForm" action="{{ url_for('accounts.accounts') }}" method="POST" class="max-w-lg ml-0 mt-4 hidden">
            <input type="hidden" name="action" value="login">
            <div class="mb-4">
                <label for="login_email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                <input type="email" id="login_email" name="email" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="login_password" class="block text-gray-700 text-sm font-bold mb-2">Пароль:</label>
                <input type="password" id="login_password" name="password" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="flex items-center justify-between">
                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Увійти
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Модальне вікно для повідомлення -->
<div id="messageModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900">Успішно!</h3>
            <div class="mt-2 px-7 py-3">
                <p id="modalMessage" class="text-sm text-gray-500"></p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="closeModal" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    Закрити
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Повідомлення про помилку -->
<div id="errorAlert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    <p id="errorMessage"></p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const registerTab = document.getElementById('registerTab');
    const loginTab = document.getElementById('loginTab');
    const registerForm = document.getElementById('registerForm');
    const loginForm = document.getElementById('loginForm');
    const modal = document.getElementById('messageModal');
    const closeButton = document.getElementById('closeModal');
    const errorAlert = document.getElementById('errorAlert');

    // Переключення вкладок
    registerTab.addEventListener('click', function() {
        registerForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
        registerTab.classList.replace('bg-gray-300', 'bg-blue-500');
        registerTab.classList.remove('text-gray-800');
        registerTab.classList.add('text-white');
        loginTab.classList.replace('bg-blue-500', 'bg-gray-300');
        loginTab.classList.add('text-gray-800');
        loginTab.classList.remove('text-white');
    });

    loginTab.addEventListener('click', function() {
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
        loginTab.classList.replace('bg-gray-300', 'bg-blue-500');
        loginTab.classList.remove('text-gray-800');
        loginTab.classList.add('text-white');
        registerTab.classList.replace('bg-blue-500', 'bg-gray-300');
        registerTab.classList.add('text-gray-800');
        registerTab.classList.remove('text-white');
    });

    // Обробка форм
    function handleFormSubmit(form, isLogin = false) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            errorAlert.classList.add('hidden');
            
            fetch('{{ url_for("accounts.accounts") }}', { 
                method: 'POST',
                body: new FormData(form),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('modalTitle').textContent = 'Успішно!';
                    document.getElementById('modalMessage').textContent = data.message || (isLogin ? 'Добро пожалувати!' : 'Аккаунт успішно створено! Тепер можете робити замовлення швидше.');
                    modal.classList.remove('hidden');
                    form.reset();
                    // Перезавантажуємо сторінку через 2 секунди
                    setTimeout(() => location.reload(), 2000);
                } else {
                    document.getElementById('errorMessage').textContent = data.message || 'Сталася помилка. Спробуйте ще раз.';
                    errorAlert.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('errorMessage').textContent = 'Помилка з\'єднання. Спробуйте ще раз.';
                errorAlert.classList.remove('hidden');
            });
        });
    }

    handleFormSubmit(registerForm, false);
    handleFormSubmit(loginForm, true);

    closeButton.addEventListener('click', function() {
        modal.classList.add('hidden');
    });
});
</script>
{% endblock %}
